---
title: "HiCool"
author: "Jacques Serizay"
date: "`r Sys.Date()`"
output: 
    BiocStyle::html_document
vignette: >
    %\VignetteIndexEntry{HiCool}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---

```{r, eval = TRUE, echo=FALSE, results="hide", message = FALSE, warning = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
suppressPackageStartupMessages({
    library(HiCool)
})
```

# Processing sequencing Hi-C libraries with `HiCool`

The `HiCool` R/Bioconductor package provides an **end-to-end interface** to 
process and normalize Hi-C paired-end fastq reads into `.(m)cool` files.

1. The heavy lifting (fastq mapping, pairs parsing and pairs filtering) is 
performed by the underlying lightweight `hicstuff` python library 
([https://github.com/koszullab/hicstuff](https://github.com/koszullab/hicstuff)).
2. Pairs filering is done using the approach described in 
[Cournac et al., 2012](https://doi.org/10.1186/1471-2164-13-436) and implemented
in `hicstuff`.
3. `cooler` ([https://github.com/open2c/cooler](https://github.com/open2c/cooler)) 
library is used to parse pairs into a multi-resolution, balanced `.mcool` file. 
`.(m)cool` is a compact, indexed HDF5 file format specifically tailored 
for efficiently storing HiC-based data. The `.(m)cool`  file format was 
developed by Abdennur and Mirny and 
[published in 2019](https://doi.org/10.1093/bioinformatics/btz540).
4. Internally, all these external dependencies are automatically installed and 
managed in R by a `basilisk` environment.

The main processing function offered in this package is `HiCool()`.
To process `.fastq` reads into `.pairs` & `.mcool` files, one needs to provide: 

- The path to each fastq file (`r1` and `r2`);
- The genome reference, as a path to a `.fasta` sequence file, a path to a pre-computed `bowtie2` index 
or a supported ID character (`hg38`, `mm10`, `dm6`, `R64-1-1`, `WBcel235`, `GRCz10`, 
`Galgal4`);
- The restriction enzyme(s) used for Hi-C.

```{r eval = FALSE}
library(HiCool)
x <- HiCool(
    r1 = '<PATH-TO-R1.fq.gz>', 
    r2 = '<PATH-TO-R2.fq.gz>', 
    restriction = 'DpnII,HinfI', 
    genome = 'R64-1-1'
)
```

```{r echo = FALSE}
## HiCool :: Recovering bowtie2 genome index from AWS iGenomes...
## HiCool :: Initiating processing of fastq files [tmp folder: /tmp/RtmpARIRQo/DZ28I8]...
## HiCool :: Mapping fastq files...
## HiCool :: Best-suited minimum resolution automatically inferred: 1000
## HiCool :: Remove unwanted chromosomes...
## HiCool :: Generating multi-resolution .mcool file...
## HiCool :: Balancing .mcool file...
## HiCool :: Tidying up everything for you...
## HiCool :: .fastq to .mcool processing done!
## HiCool :: Check /home/rsg/repos/HiCool/HiCool folder to find the generated files
## HiCool :: Generating HiCool report. This might take a while.
## HiCool :: Report generated and available @ sample^mapped-R64-1-1^DZ28I8.html
## HiCool :: All processing successfully achieved. Congrats!
```

# Output files

The files generated by `HiCool` are the following: 

- A log file: `<output_folder>/logs/<prefix>^mapped-<genome>^<hash>.log`
- A multi-resolution, balanced contact matrix file: `<output_folder>/matrices/<prefix>^mapped-<genome>^<hash>.mcool`
- A `.pairs` file: `<output_folder>/pairs/<prefix>^mapped-<genome>^<hash>.pairs`
- Several diagnosis plots: `<output_folder>/plots/<prefix>^mapped-<genome>^<hash>_*.pdf`

```{r echo = FALSE}
## HiCool/
## |-- sample^mapped-R64-1-1^55IONQ.html
## |-- logs
## |   |-- sample^mapped-R64-1-1^55IONQ.log
## |-- matrices
## |   |-- sample^mapped-R64-1-1^55IONQ.mcool
## |-- pairs
## |   |-- sample^mapped-R64-1-1^55IONQ.pairs
## `-- plots
##     |-- sample^mapped-R64-1-1^55IONQ_event_distance.pdf
##     |-- sample^mapped-R64-1-1^55IONQ_event_distribution.pdf
```

Note:

- `.pairs` file format is defined by the [4DN consortium](https://github.com/4dn-dcic/pairix/blob/master/pairs_format_specification.md);
- `.(m)cool` file format is defined by `cooler` authors in the [supporting publication](https://doi.org/10.1093%2Fbioinformatics%2Fbtz540).

# System dependencies

Processing Hi-C sequencing libraries into `.pairs` and `.mcool` files requires 
several dependencies, to (1) align reads to a reference genome, (2) manage 
alignment files (SAM), (3) filter pairs, (4) bin them to a specific resolution 
and (5) 

All system dependencies are internally managed by `basilisk`. `HiCool` maintains 
a `basilisk` environment containing: 

- `python 3.9.1`
- `bowtie2 2.4.5`
- `samtools 1.7`
- `hicstuff 3.1.5`
- `cooler 0.8.11`
- `chromosight 1.6.3`

The first time `HiCool()` is executed, a fresh `basilisk` environment will 
be created and required dependencies automatically installed. This ensures 
compatibility between the different system dependencies needed to process 
Hi-C fastq files. 

# Session info

```{r session}
sessionInfo()
```
